<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>サニックスアイズ | 異常発電量一覧表</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon">
  </head>
  <body style="margin-top:70px">
    <div style="width:auto" class="container">
      <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid"></div>
        <div class="navbar-header"><a href="index.html" class="navbar-brand">サニックスアイズ</a></div>
        <div id="bs-example-navbar-collapse-1" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="index.html">PVセンサー一覧</a></li>
            <li><a href="lowGeneration.html">低発電量一覧表</a></li>
            <li><a href="lowGeneration2.html">未復旧故障一覧</a></li>
            <li class="active"><a href="abnormalGeneration.html">異常発電量一覧表</a></li>
            <li><a href="noticeMail.html">通知メール一覧</a></li>
            <li><a href="nameList.html">社員名簿</a></li>
            <li><a href="administrators.html">管理者一覧</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="active"><a href="https://sanix-eye.jp/7db01ea67f5f30305d9958cce3bc9b48/" target="_blank">サニックスアイ管理ページへ</a></li>
          </ul>
        </div>
      </nav>
      <div style="margin:0 10px 0 10px">
        <div style="margin-bottom:12px" class="form-inline"><a id="yesterday" class="btn btn-default">前日</a><span id="mydate" style="font-size:22px"></span><a id="tommorow" class="btn btn-default">翌日</a></div>
        <div id="accordion" class="panel-group">
          <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
          <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
          <script>
            function getUrlVars() {
              'use strict';
              var vars = [], hash;
              var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
              for(var i = 0; i < hashes.length; i++)
              {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
              }
              return vars;
            }
            
            $(document).ready(function() {
              'use strict';
              var args = getUrlVars();
              var date;
              if (args.length === 3) {
                date = new Date(args.year, args.month - 1, args.day);
              } else {
                date = new Date();
                date.setDate(date.getDate() - 1);
              }
              var yesterday = new Date(date.getFullYear(), date.getMonth(), date.getDate());
              yesterday.setDate(yesterday.getDate() - 1);
              $('#yesterday').attr("href", "?year=" + yesterday.getFullYear() + "&month=" + (yesterday.getMonth() + 1) + "&day=" + yesterday.getDate());
              $('#yesterday').text("前日");
            
              var tommorow = new Date(date.getFullYear(), date.getMonth(), date.getDate());
              tommorow.setDate(tommorow.getDate() + 1);
              $('#tommorow').attr("href", "?year=" + tommorow.getFullYear() + "&month=" + (tommorow.getMonth() + 1) + "&day=" + tommorow.getDate());
              $('#tommorow').text("翌日");
            
              var strDate = date.getFullYear() + "/" + (date.getMonth() + 1) + "/" + date.getDate();
              $('#mydate').html('&nbsp;' + strDate + '&nbsp;');
              $.getJSON("https://s3-ap-northeast-1.amazonaws.com/sanix-data-analysis/fhRK0XGVb3cR1r1S3x9j3j3DRFGUyRYC/abnormalGeneration/" + strDate + ".json", function (json) {
                $.getJSON("https://s3-ap-northeast-1.amazonaws.com/sanix-data-analysis/fhRK0XGVb3cR1r1S3x9j3j3DRFGUyRYC/pv_sensors.json", function (pvsensors) {
                  var header = [ 'パワコン番号', '積算電力', '前回積算電力', '差分', '日時', '前回日時', '変化係数' ];
                  var res = '';
                  var num = 0;
                  var keys = [];
                  for (var id in json) {
                    keys.push(id);
                  }
                  keys.sort(function (a, b) {
                    if (a < b) return -1;
                    if (a > b) return 1;
                    return 0;
                  });
                  keys.forEach(function (id) {
                    var list = json[id].Series;
                    res += '<div class="panel panel-default">';
                    res += '<div class="panel-heading">';
                    res += '<h4 class="panel-title">';
                    res += '<a data-toggle="collapse" data-parent="#accordion" href="#collapse' + num + '">';
                    res += id + '(' + list.length + '件) ' + json[id].発電所名 + '発電所(' + json[id].営業所 + ') ' + json[id].メーカー + ':' + json[id].機種名 + '(ファームバージョン:' + json[id].プログラムバージョン + ')</a></p>\n';
                    res += '</a>';
                    res += '</h4>';
                    res += '</div>';
                    res += '<div id="collapse' + num + '" class="panel-collapse collapse">';
                    res += '<div class="panel-body">';
                    res += '<table class="table"><thead><th>&nbsp;</th>';
                    for (var column = 0; column < header.length; column++) {
                      res += '<th style="padding:8px 15px;">' + header[column] + '</th>';
                    }
                    res += '</tr></thead><tbody>';
                    for (var row in list) {
                      res += '<tr>';
                      var line = list[row];
                      res += "<td><a style='padding:0;' href='" + pvsensors[id].URL.replace(/\/pv_sensor/, "/rawdata") + "' target='_blank'>開く</a></td>";
                      for (column = 0; column < header.length; column++) {
                        res += '<td>' + line[header[column]] + '</td>';
                      }
                      res += '</tr>';
                    }
                    res += '</tbody></table></div></div></div>';
                    num++;
                  });
                  $('#accordion').html(res);
                  console.log(res);
                });
              });
            });
          </script>
        </div>
      </div>
    </div>
  </body>
</html>