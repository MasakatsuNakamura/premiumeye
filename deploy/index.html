<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>サニックスアイズ | PVセンサー一覧</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon">
  </head>
  <body style="margin-top:70px">
    <div style="width:auto" class="container">
      <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid"></div>
        <div class="navbar-header"><a href="index.html" class="navbar-brand">サニックスアイズ</a></div>
        <div id="bs-example-navbar-collapse-1" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="index.html">PVセンサー一覧</a></li>
            <li><a href="lowGeneration.html">低発電量一覧表</a></li>
            <li><a href="lowGeneration2.html">未復旧故障一覧</a></li>
            <li><a href="abnormalGeneration.html">異常発電量一覧表</a></li>
            <li><a href="noticeMail.html">通知メール一覧</a></li>
            <li><a href="nameList.html">社員名簿</a></li>
            <li><a href="administrators.html">管理者一覧</a></li>
            <li><a href="tabuchiInputvol.html">田淵入力電圧異常</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://sanix-eye.jp/7db01ea67f5f30305d9958cce3bc9b48/" target="_blank">サニックスアイ管理ページへ</a></li>
          </ul>
        </div>
      </nav>
      <div style="margin:0 10px 0 10px">
        <div style="margin-bottom:12px" class="form-inline">
          <input id="sortby" type="hidden">
          <label for="search">検索条件：</label>
          <input id="search" size="80" class="form-control">
          <button id="search-btn" class="btn btn-default">絞込み</button>
          <button id="all-btn" class="btn btn-default">すべて</button>
          <button id="sanix" class="btn btn-default">古サニックス</button>
          <button id="tabuchi" class="btn btn-default">要VerUP</button>
          <button id="pana" class="btn btn-default">パナ6台以上</button>
          <button id="wide" class="btn btn-default">ワイド逆向き</button>
        </div>
        <div style="margin-bottom:12px" class="form-inline">
          <label for="numbers">検索結果：</label><span id="numbers">&nbsp;</span>
          <label for="page">ページ：</label>
          <select id="page"></select>
        </div>
        <div>
          <table class="table">
            <thead>
              <tr>
                <th>No</th>
                <th>シリアル番号</th>
                <th>発電所名</th>
                <th>顧客名</th>
                <th>プラン</th>
                <th>営業所</th>
                <th>パワコン台数</th>
                <th>ステータス</th>
                <th>メーカー</th>
                <th>機種名</th>
                <th>プログラムバージョン</th>
                <th>センサー向き</th>
                <th>パワコン情報</th>
              </tr>
            </thead>
            <tbody id="list"></tbody>
          </table>
          <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
          <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
          <script>
            function getUrlVars() {
              'use strict';
              var vars = [], hash;
              var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
              for(var i = 0; i < hashes.length; i++)
              {
                  hash = hashes[i].split('=');
                  vars.push(hash[0]);
                  vars[hash[0]] = hash[1];
              }
              return vars;
            }
            
            $(document).ready(function() {
              'use strict';
              //イベントハンドラ
            
              // 引数解析
              var args = getUrlVars();
              if ('search' in args) {
                $('#search').val(decodeURI(args.search));
              }
              if ('sortby' in args) {
                $('#sortby').val(decodeURI(args.sortby));
              } else {
                $('#sortby').val('シリアル番号');
              }
              var header = ["シリアル番号","発電所名","顧客名","プラン","営業所","パワコン台数","ステータス","メーカー","機種名","プログラムバージョン","センサー向き","パワコン情報"];
              var size = 20;
              var num = 0;
              var pages = 0;
              search_fn();
            
              function search_fn() {
                'use strict';
                $.getJSON("https://s3-ap-northeast-1.amazonaws.com/sanix-data-analysis/fhRK0XGVb3cR1r1S3x9j3j3DRFGUyRYC/pv_sensors.json", function (json) {
                  function draw() {
                    var p = parseInt($('#page').val());
                    var tbl = "";
                    var values = {};
                    for (var i = 0; i < header.length; i++) {
                      var cell = header[i];
                      values[cell] = {};
                    }
                    for (i = p * size; i < p * size + size; i++) {
                      if (i >= num) break;
                      var line = data[i];
                      tbl += "<tr><td>" + (i + 1) + "</td>";
                      for (var j = 0; j < header.length; j++) {
                        var cell = header[j];
                        var value = line[cell];
                        if (cell === "発電所名") {
                          var value = '<a href="https://maps.google.co.jp/maps?ll=' + line['緯度'] + ',' + line['経度'] + '&z=11&q=' + line['緯度'] + ',' + line['経度'] + '+(' + encodeURI(line['発電所名'] + '発電所') + ')&hl=ja&iwloc=A" target="_blank">' + line['発電所名'] + '発電所</a>';
                        } else if (cell === "シリアル番号") {
                          var value = '<a href="' + line['URL'] + '" target="_blank">' + line['シリアル番号'] + '</a>';
                        }
                        tbl += "<td>" + value.toString().replace(/\n/g, '<br />') + "</td>";
                        values[cell][line[cell]] = true;
                      }
                      tbl += "</tr>";
                    }
                    tbl += "</table>";
                    $("#list").html(tbl);
                    var date = new Date();
                    $("#numbers").text(num + " 箇所 (" + date.getFullYear() + "年" + (date.getMonth() + 1) + "月" + date.getDate() + "日 時点)");
                  }
            
                  $("#page").change(function(){
                    draw();
                  });
                  $("#search-btn").attr("tabindex", "0");
                  $("#search-btn").click(function(){
                    location.href = '?search=' + $('#search').val();
                  });
                  $("#all-btn").click(function(){
                    location.href = '?search=';
                  });
                  $("#sanix").click(function(){
                    location.href = '?search=' + "SA099T01 V[0-6][0-9A-F]";
                  });
                  $("#tabuchi").click(function(){
                    location.href = '?search=' + "田淵電機 1\\.0[0-8] or 安川電機 1\\.0[0-5] or SA099T01 1\\.0[0-8] or P73H103RJ 1\\.(0[0-9]|1[01])";
                  });
                  $("#pana").click(function(){
                    location.href = '?search=' + "SP(SS|SM|US) ,([6-9]|1[0-9]), パワコン 初期化待ち|アクティベート待ち";
                  });
                  $("#wide").click(function(){
                    location.href = '?search=' + "電力量センサー ,逆,";
                  });
                  $("input").keydown(function(e) {
                    if (e.keyCode === 13) {
                      location.href = '?search=' + $('#search').val();
                    }
                  });
                  var data = [];
                  var search = $("#search").val();
                  var searches = search.split(/ or /);
                  if (searches.length === 0) {
                    searches[0] = search;
                  }
                  for (var mysearch in searches) {
                    searches[mysearch] = '^(?=.*' + searches[mysearch].split(/\s+/).join(')(?=.*') + ')';
                  }
                  var re = new RegExp(searches.join('|'), "i");
                  console.log(searches.join('|'));
                  num = 0;
                  for (var id in json) {
                    var line = [];
                    for (var item in header) {
                      var val = json[id][header[item]];
                      json[id][header[item]] = val ? val : '&nbsp;';
                      line.push((json[id][header[item]] + '').replace("\n", " "));
                    }
                    if (!json[id]['テスト'] && (search === '' || line.join(',').match(re))) {
                      data.push(json[id]);
                      num++;
                    }
                  }
            
                  if ($('#sortby').val() !== '') {
                    data.sort(function(val1, val2) {
                      val1 = val1[$('#sortby').val()];
                      val2 = val2[$('#sortby').val()];
                      if (val1 < val2) {
                        return -1;
                      } else if (val1 > val2) {
                        return 1;
                      } else {
                        return 0;
                      }
                    });
                  }
            
                  pages = parseInt(num / size) + 1;
                  var page = '';
                  for (var i = 0; i < pages; i++) {
                    page += '<option value="' + i + '"">' + (i + 1) + ' / ' + pages + '</option>';
                  }
                  $("#page").html(page);
                  draw();
                });
              }
            });
          </script>
        </div>
      </div>
    </div>
  </body>
</html>