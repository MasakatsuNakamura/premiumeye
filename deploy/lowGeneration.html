<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>サニックスアイズ | 低発電量一覧表</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon">
  </head>
  <body style="margin-top:70px">
    <div style="width:auto" class="container">
      <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid"></div>
        <div class="navbar-header"><a href="index.html" class="navbar-brand">サニックスアイズ</a></div>
        <div id="bs-example-navbar-collapse-1" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="index.html">PVセンサー一覧</a></li>
            <li class="active"><a href="lowGeneration.html">低発電量一覧表</a></li>
            <li><a href="lowGeneration2.html">未復旧故障一覧</a></li>
            <li><a href="abnormalGeneration.html">異常発電量一覧表</a></li>
            <li><a href="noticeMail.html">通知メール一覧</a></li>
            <li><a href="nameList.html">社員名簿</a></li>
            <li><a href="administrators.html">管理者一覧</a></li>
            <li><a href="tabuchiInputvol.html">田淵入力電圧異常</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://sanix-eye.jp/7db01ea67f5f30305d9958cce3bc9b48/" target="_blank">サニックスアイ管理ページへ</a></li>
          </ul>
        </div>
      </nav>
      <div style="margin:0 10px 0 10px">
        <div class="form-inline"><a id="yesterday" class="btn btn-default">前日</a><span id="mydate" style="font-size:22px"></span><a id="tommorow" class="btn btn-default">翌日</a>
          <button class="btn btn-danger">※ 赤部分は、「電力量低下」エラーが重複して出ているもの</button>
          <button class="btn btn-success">※ 緑部分は、「電力量低下」エラーが単体で出ているもの</button>
        </div>
        <div>
          <table class="table">
            <thead>
              <tr>
                <th>シリアル番号</th>
                <th>発電所名</th>
                <th>営業所</th>
                <th>メーカー</th>
                <th>機種</th>
                <th>プラン</th>
                <th>発電力量</th>
                <th>定格出力</th>
                <th>偏差値</th>
                <th>周辺順位</th>
                <th>周辺発電所数</th>
              </tr>
            </thead>
            <tbody id="list"></tbody>
          </table>
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script>
          function getUrlVars() {
            'use strict';
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for(var i = 0; i < hashes.length; i++) {
              hash = hashes[i].split('=');
              vars.push(hash[0]);
              vars[hash[0]] = hash[1];
            }
            return vars;
          }
          
          $(document).ready(function() {
            'use strict';
            var args = getUrlVars();
            var date;
            if (args.length == 3) {
              date = new Date(args.year, args.month - 1, args.day);
            } else {
              date = new Date();
              date.setDate(date.getDate() - 1);
            }
            var yesterday = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            yesterday.setDate(yesterday.getDate() - 1);
            $('#yesterday').attr("href", "?year=" + yesterday.getFullYear() + "&month=" + (yesterday.getMonth() + 1) + "&day=" + yesterday.getDate());
            $('#yesterday').text("前日");
          
            var tommorow = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            tommorow.setDate(tommorow.getDate() + 1);
            $('#tommorow').attr("href", "?year=" + tommorow.getFullYear() + "&month=" + (tommorow.getMonth() + 1) + "&day=" + tommorow.getDate());
            $('#tommorow').text("翌日");
          
            var strDate = date.getFullYear() + "/" + (date.getMonth() + 1) + "/" + date.getDate();
            $('#mydate').html('&nbsp;' + strDate + '&nbsp;');
            $.getJSON("https://s3-ap-northeast-1.amazonaws.com/sanix-data-analysis/fhRK0XGVb3cR1r1S3x9j3j3DRFGUyRYC/detectLowGeneration/" +
             strDate + ".json", function (json) {
              $.getJSON("https://s3-ap-northeast-1.amazonaws.com/sanix-data-analysis/fhRK0XGVb3cR1r1S3x9j3j3DRFGUyRYC/pv_sensors.json", function (pvsensors) {
                var header = ["シリアル番号","発電所名","営業所","メーカー","機種","プラン","発電力量","定格出力","偏差値","周辺順位","周辺発電所数"];
                var keys = [];
                for (var id in json) {
                  keys.push(id);
                }
                keys.sort(function (a, b) {
                  if (json[a].偏差値 < json[b].偏差値) return -1;
                  if (json[a].偏差値 > json[b].偏差値) return 1;
                  return 0;
                });
                var res = '';
                keys.forEach(function (id) {
                  if (id in pvsensors) {
                    var list = json[id];
                    list['偏差値'] = Math.round(list.偏差値 * 10)/ 10;
                    list['発電力量'] = Math.round(list.発電力量 * 100)/ 100;
                    list['定格出力'] = Math.round(list.定格出力 * 10)/ 10;
                    if (list['偏差値'] < 42 || list.電力量低下) {
                      var style = '';
                      if (list.電力量低下 && list.偏差値 < 42.5) {
                        style = 'danger';
                      } else if (list.電力量低下) {
                        style = 'success';
                      }
                      res += '<tr class=' + style + '><td><a href=' + pvsensors[id].URL + ' target="_blank">' + id + '</a></td><td>' + pvsensors[id].発電所名 + '発電所</td><td>' + pvsensors[id].営業所+ '</td><td>' + pvsensors[id].メーカー + '</td><td>' + pvsensors[id].機種名 + '</td><td>' + pvsensors[id].プラン + '</td>';
                      for (var i = 0; i < header.length - 6; i++) {
                        res += '<td>' + list[header[i + 6]] + '</td>';
                      }
                      res += '</tr>\n';
                    }
                  }
                });
                $('#list').html(res);
              });
            });
          });
        </script>
      </div>
    </div>
  </body>
</html>