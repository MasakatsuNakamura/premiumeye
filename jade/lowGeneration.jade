extends ./components/_header
block content
  .form-inline
    a#yesterday.btn.btn-default 前日
    span#mydate(style="font-size:22px")
    a#tommorow.btn.btn-default 翌日
    button.btn.btn-danger ※ 赤部分は、「電力量低下」エラーが重複して出ているもの
    button.btn.btn-success ※ 緑部分は、「電力量低下」エラーが単体で出ているもの
  div
    - var header = ['シリアル番号', '発電所名', '営業所', 'メーカー', '機種', 'プラン', '発電力量', '定格出力', '偏差値', '周辺順位', '周辺発電所数' ]
    table.table
      thead
        tr
          each name in header
            th=name
      tbody#list
  script(src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js")
  script(src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js")
  script.
    function getUrlVars() {
      'use strict';
      var vars = [], hash;
      var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
      for(var i = 0; i < hashes.length; i++) {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
      }
      return vars;
    }

    $(document).ready(function() {
      'use strict';
      var args = getUrlVars();
      var date;
      if (args.length == 3) {
        date = new Date(args.year, args.month - 1, args.day);
      } else {
        date = new Date();
        date.setDate(date.getDate() - 1);
      }
      var yesterday = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      yesterday.setDate(yesterday.getDate() - 1);
      $('#yesterday').attr("href", "?year=" + yesterday.getFullYear() + "&month=" + (yesterday.getMonth() + 1) + "&day=" + yesterday.getDate());
      $('#yesterday').text("前日");

      var tommorow = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      tommorow.setDate(tommorow.getDate() + 1);
      $('#tommorow').attr("href", "?year=" + tommorow.getFullYear() + "&month=" + (tommorow.getMonth() + 1) + "&day=" + tommorow.getDate());
      $('#tommorow').text("翌日");

      var strDate = date.getFullYear() + "/" + (date.getMonth() + 1) + "/" + date.getDate();
      $('#mydate').html('&nbsp;' + strDate + '&nbsp;');
      $.getJSON("https://s3-ap-northeast-1.amazonaws.com/sanix-data-analysis/fhRK0XGVb3cR1r1S3x9j3j3DRFGUyRYC/detectLowGeneration/" +
       strDate + ".json", function (json) {
        $.getJSON("https://s3-ap-northeast-1.amazonaws.com/sanix-data-analysis/fhRK0XGVb3cR1r1S3x9j3j3DRFGUyRYC/pv_sensors.json", function (pvsensors) {
          var header = !{JSON.stringify(header)};
          var keys = [];
          for (var id in json) {
            keys.push(id);
          }
          keys.sort(function (a, b) {
            if (json[a].偏差値 < json[b].偏差値) return -1;
            if (json[a].偏差値 > json[b].偏差値) return 1;
            return 0;
          });
          var res = '';
          keys.forEach(function (id) {
            if (id in pvsensors) {
              var list = json[id];
              list['偏差値'] = Math.round(list.偏差値 * 10)/ 10;
              list['発電力量'] = Math.round(list.発電力量 * 100)/ 100;
              list['定格出力'] = Math.round(list.定格出力 * 10)/ 10;
              if (list['偏差値'] < 42 || list.電力量低下) {
                var style = '';
                if (list.電力量低下 && list.偏差値 < 42.5) {
                  style = 'danger';
                } else if (list.電力量低下) {
                  style = 'success';
                }
                res += '<tr class=' + style + '><td><a href=' + pvsensors[id].URL + ' target="_blank">' + id + '</a></td><td>' + pvsensors[id].発電所名 + '発電所</td><td>' + pvsensors[id].営業所+ '</td><td>' + pvsensors[id].メーカー + '</td><td>' + pvsensors[id].機種名 + '</td><td>' + pvsensors[id].プラン + '</td>';
                for (var i = 0; i < header.length - 6; i++) {
                  res += '<td>' + list[header[i + 6]] + '</td>';
                }
                res += '</tr>\n';
              }
            }
          });
          $('#list').html(res);
        });
      });
    });
