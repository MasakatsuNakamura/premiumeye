<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>サニックスアイズ</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon">
  </head>
  <body>
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <div class="navbar-header"></div><a href="index.html" class="navbar-brand">サニックスアイズ</a>
        <button type="button" data-toggle="collapse" data-target="#nav-content" class="navbar-toggle collapsed"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button>
        <div id="nav-content" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="index.html">PVセンサー一覧</a></li>
            <li><a href="lowGeneration2.html">未復旧故障一覧</a></li>
            <li class="dropdown"><a href="#" data-toggle="dropdown" class="dwopdown-toggle">異常検出<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="lowGeneration.html">低発電量一覧表</a></li>
                <li><a href="abnormalGeneration.html">異常発電量一覧表</a></li>
                <li><a href="tabuchiInputvol.html">田淵入力電圧異常</a></li>
              </ul>
            </li>
            <li class="dropdown"><a href="#" data-toggle="dropdown" class="dwopdown-toggle">その他<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="noticeMail.html">通知メール一覧</a></li>
                <li><a href="nameList.html">社員名簿</a></li>
                <li><a href="administrators.html">管理者一覧</a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://sanix-eye.jp/7db01ea67f5f30305d9958cce3bc9b48/" target="_blank">サニックスアイ管理ページへ</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div style="margin:0 10px 0 10px">
      <div class="form-inline"><a id="yesterday" class="btn btn-default">前日</a><span id="mydate" style="font-size:22px"></span><a id="tommorow" class="btn btn-default">翌日</a>
        <div class="alert alert-success">
          <h3>データがロックしている（固まっている）発電所</h3>
          <p>検出条件）12/13/14時の3サンプリングで入力電圧がまったく変化していない</p>
        </div>
        <div class="alert alert-danger">
          <h3>入力電圧が低い（異常）可能性のある発電所</h3>
          <p>検出条件1）緑のデータロックが発生していないこと</p>
          <p>検出条件2）入力電圧のバラつきが大きい発電所内(分散>1000)の偏差値50以下が12/13/14時の3サンプリング連続した場合</p>
          <p>※入力電圧0はさすがにPVを接続していないと断定し、判定には加えていない。</p>
        </div>
      </div>
      <div>
        <table class="table">
          <thead>
            <tr>
              <th>シリアル番号</th>
              <th>パワコン番号</th>
              <th>発電所</th>
              <th>営業所</th>
              <th>時間</th>
              <th>入力電圧1</th>
              <th>入力電圧2</th>
              <th>入力電圧3</th>
              <th>入力電圧4</th>
              <th>入力電圧5</th>
              <th>分散</th>
            </tr>
          </thead>
          <tbody id="list"></tbody>
        </table>
      </div>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
      <script>
        function getUrlVars() {
          'use strict';
          var vars = [], hash;
          var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
          for(var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
          }
          return vars;
        }
        
        $(document).ready(function() {
          'use strict';
          var args = getUrlVars();
          var date;
          if (args.length == 3) {
            date = new Date(args.year, args.month - 1, args.day);
          } else {
            date = new Date();
            date.setDate(date.getDate() - 1);
          }
          var yesterday = new Date(date.getFullYear(), date.getMonth(), date.getDate());
          yesterday.setDate(yesterday.getDate() - 1);
          $('#yesterday').attr("href", "?year=" + yesterday.getFullYear() + "&month=" + (yesterday.getMonth() + 1) + "&day=" + yesterday.getDate());
          $('#yesterday').text("前日");
        
          var tommorow = new Date(date.getFullYear(), date.getMonth(), date.getDate());
          tommorow.setDate(tommorow.getDate() + 1);
          $('#tommorow').attr("href", "?year=" + tommorow.getFullYear() + "&month=" + (tommorow.getMonth() + 1) + "&day=" + tommorow.getDate());
          $('#tommorow').text("翌日");
        
          var strDate = date.getFullYear() + "/" + (date.getMonth() + 1) + "/" + date.getDate();
          $('#mydate').html('&nbsp;' + strDate + '&nbsp;');
          $.getJSON("https://s3-ap-northeast-1.amazonaws.com/sanix-data-analysis/fhRK0XGVb3cR1r1S3x9j3j3DRFGUyRYC/tabuchi-inputvol-detect/" + strDate + ".json", function (json) {
            $.getJSON("https://s3-ap-northeast-1.amazonaws.com/sanix-data-analysis/fhRK0XGVb3cR1r1S3x9j3j3DRFGUyRYC/pv_sensors.json", function (pvsensors) {
              var header = ["シリアル番号","パワコン番号","発電所","営業所","時間","入力電圧1","入力電圧2","入力電圧3","入力電圧4","入力電圧5","分散"];
              var res = '';
              for (var id in json) {
                //console.log(id);
                for(var i=0; i<json[id].length; i++) {
                  var class_style = '';
                  var rowspan_num = '';
                  if(json[id][i].inv_vol_num === 1) {
                    class_style = ' class=success';
                  } else {
                    rowspan_num = ' rowspan=3';
                  }
                  var write = 1;
                  for(var k=0; k<json[id][i].inv_vol_num; k++) {
                    res += '<tr' + class_style + '>';
                    if(write === 1) {
                      res += '<td' + rowspan_num + '><a href=' + pvsensors[id].URL + ' target="_blank">' + id + '</a></td>';
                      res += '<td' + rowspan_num + '>' + json[id][i].pcsid + '</td>';
                      res += '<td' + rowspan_num + '>' + pvsensors[id].発電所名 + '発電所</td>';
                      res += '<td' + rowspan_num + '>' + pvsensors[id].営業所 + '</td>';
                    }
                    write = 0;
                    res += '<td>' + String(12+k) + '時' + '</td>';
                    for(var j=0; j<5; j++) {
                      var style2 = '';
                      if(json[id][i].result_out[j] === 1) {
                        style2 = 'danger';
                      }
                      res += '<td class='+ style2 + '>' + json[id][i].input[k].input_vol[j] + '</td>';
                    }
                    res += '<td>' + json[id][i].input[k].dispersion + '</td>';
                    res += '</tr>/n';
                  }
                }
              }
              $('#list').html(res);
            });
          });
        });
      </script>
    </div>
  </body>
</html>